<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ast2ast">
<title>Information for package authors • ast2ast</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Information for package authors">
<meta property="og:description" content="ast2ast">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ast2ast</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/DetailedDocumentation.html">Detailed Documentation</a>
    <a class="dropdown-item" href="../articles/InformationForPackageAuthors.html">Information for package authors</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Konrad1991/ast2ast/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Information for package authors</h1>
                        <h4 data-toc-skip class="author">Konrad
Krämer</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Konrad1991/ast2ast/blob/HEAD/vignettes/InformationForPackageAuthors.Rmd" class="external-link"><code>vignettes/InformationForPackageAuthors.Rmd</code></a></small>
      <div class="d-none name"><code>InformationForPackageAuthors.Rmd</code></div>
    </div>

    
    
<style>
body {
text-align: justify}
</style>
<ul>
<li><a href="#guidance-for-package-authors">Guidance for Package
Authors</a></li>
<li><a href="#naming-rationalization-ast2ast">Naming rationalization
ast2ast</a></li>
<li><a href="#comparison-of-r-and-etr-code">Comparison of R and ETR
code</a></li>
<li><a href="#internals-of-etr">Internals of ETR</a></li>
<li><a href="#How-to-use-the-xptr-interface">How to use the XPtr
interface</a></li>
</ul>
<div class="section level2">
<h2 id="guidance-for-package-authors">Guidance for Package Authors<a class="anchor" aria-label="anchor" href="#guidance-for-package-authors"></a>
</h2>
<p>This section of the documentation describes how the external pointers
to C++ function that are produced by <em>ast2ast</em> can be used in
other packages. This information is intended for package authors who
want to use the translated functions within their own code.
Additionally, this section endeavors to present pertinent implementation
details, providing valuable insights into the inner workings of the
process.</p>
</div>
<div class="section level2">
<h2 id="naming-rationalization-ast2ast">Naming rationalization ast2ast<a class="anchor" aria-label="anchor" href="#naming-rationalization-ast2ast"></a>
</h2>
<p>The nomenclature of the package, ast2ast, is rooted in the
abbreviation <em>ast</em>, signifying abstract syntax tree. Originally I
planned to convert the abstract syntax tree of R to the C++ tree as the
literature recommended for transpilers. However, through iterative
refinement, a more optimal methodology emerged. The development
incorporated an Expression Template Library in C++ known as ETR,
meticulously crafted to mimic R. Thus, R code is translated into ETR
code, which is subsequently compiled. The original ETR library is
accessible at <a href="https://github.com/Konrad1991/ETR" class="external-link uri">https://github.com/Konrad1991/ETR</a>. It’s imperative to
note that the version integrated into ast2ast has undergone substantial
enhancements, amplifying its efficacy and adaptability.</p>
</div>
<div class="section level2">
<h2 id="comparison-of-r-and-etr-code">Comparison of R and ETR code<a class="anchor" aria-label="anchor" href="#comparison-of-r-and-etr-code"></a>
</h2>
<p>Displayed below is a basic bubble sort function implemented in R on
the left, juxtaposed with its ETR counterpart on the right. It is
obvious that the two code snippets are quite similar. Remarkably, the
overall structure of the R code remains unaltered. Instead, the
substitution of individual functions with their ETR equivalents forms
the crux of the transformation.<br>
In the C++ code, all functions are located in the <em>etr</em>
namespace. Certain functions share identical names in both R and C++,
such as the <em>length</em> function. To mitigate potential conflicts,
these calls are modified to explicitly reference the etr namespace,
resulting in expressions like <em>etr::length</em>. Other functions as
for example <em><code>:</code></em> and <em><code>[</code></em> cannot
be defined in C++ (at least not in the way they are used in R) therefore
they are replaced by functions with new names e.g. <em>etr::colon</em>
and <em>etr::subset</em>.<br>
Additionally, C++ necessitates explicit declaration of variable types.
Within this example for all variables the type <em>sexp</em> is used. A
detailed explanation is deferred to the subsequent section.</p>
<div class="columns">
<div class="column" style="width:35%;">
<p><br><br><br><br><br><br><br></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource r numberLines"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>bubbleSort <span class="ot">&lt;-</span> <span class="cf">function</span>(a) {</span>
<span id="cb1-2"><a href="#cb1-2"></a>  </span>
<span id="cb1-3"><a href="#cb1-3"></a>  size <span class="ot">&lt;-</span> <span class="fu">length</span>(a)</span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>size) {</span>
<span id="cb1-5"><a href="#cb1-5"></a>      <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(size <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb1-6"><a href="#cb1-6"></a>        <span class="cf">if</span> (a[j] <span class="sc">&gt;</span> a[j <span class="sc">+</span> <span class="dv">1</span>]) {</span>
<span id="cb1-7"><a href="#cb1-7"></a>          temp <span class="ot">&lt;-</span> a[j]</span>
<span id="cb1-8"><a href="#cb1-8"></a>          a[j] <span class="ot">&lt;-</span> a[j <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb1-9"><a href="#cb1-9"></a>          a[j <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> temp</span>
<span id="cb1-10"><a href="#cb1-10"></a>        }</span>
<span id="cb1-11"><a href="#cb1-11"></a>      }</span>
<span id="cb1-12"><a href="#cb1-12"></a>    }</span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="fu">return</span>(a)</span>
<span id="cb1-14"><a href="#cb1-14"></a>}  </span></code></pre></div>
</div>
<div class="column" style="width:65%;">
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">// [[Rcpp::depends(ast2ast)]]</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">// [[Rcpp::plugins(cpp2a)]]</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="pp">#include </span><span class="im">"etr.hpp"</span></span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>SEXP getXPtr<span class="op">();</span></span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a>sexp bubbleSort<span class="op">(</span>sexp a<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>   sexp size<span class="op">;</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>   sexp temp<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>   size <span class="op">=</span> etr<span class="op">::</span>length<span class="op">(</span>a<span class="op">);</span>  </span>
<span id="cb2-13"><a href="#cb2-13"></a>   <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;</span>i<span class="op">:</span>  etr<span class="op">::</span>colon<span class="op">(</span>etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">1</span><span class="op">),</span> size<span class="op">))</span> <span class="op">{;</span>   </span>
<span id="cb2-14"><a href="#cb2-14"></a>       <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;</span>j<span class="op">:</span>  etr<span class="op">::</span>colon<span class="op">(</span>etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="op">(</span>size <span class="op">-</span> etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">1</span><span class="op">))))</span> <span class="op">{;</span>   </span>
<span id="cb2-15"><a href="#cb2-15"></a>           <span class="cf">if</span> <span class="op">(</span>etr<span class="op">::</span>subset<span class="op">(</span>a<span class="op">,</span> j<span class="op">)</span> <span class="op">&gt;</span> etr<span class="op">::</span>subset<span class="op">(</span>a<span class="op">,</span> j <span class="op">+</span> etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">1</span><span class="op">)))</span> <span class="op">{;</span>   </span>
<span id="cb2-16"><a href="#cb2-16"></a>               temp <span class="op">=</span> etr<span class="op">::</span>subset<span class="op">(</span>a<span class="op">,</span> j<span class="op">);</span>   </span>
<span id="cb2-17"><a href="#cb2-17"></a>               etr<span class="op">::</span>subset<span class="op">(</span>a<span class="op">,</span> j<span class="op">)</span> <span class="op">=</span> etr<span class="op">::</span>subset<span class="op">(</span>a<span class="op">,</span> j <span class="op">+</span> etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">1</span><span class="op">));</span>  </span>
<span id="cb2-18"><a href="#cb2-18"></a>               etr<span class="op">::</span>subset<span class="op">(</span>a<span class="op">,</span> j <span class="op">+</span> etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">1</span><span class="op">))</span> <span class="op">=</span> temp<span class="op">;</span>   </span>
<span id="cb2-19"><a href="#cb2-19"></a>           <span class="op">};</span>  </span>
<span id="cb2-20"><a href="#cb2-20"></a>       <span class="op">};</span>  </span>
<span id="cb2-21"><a href="#cb2-21"></a>   <span class="op">};</span>  </span>
<span id="cb2-22"><a href="#cb2-22"></a>   <span class="cf">return</span><span class="op">(</span>a<span class="op">);</span>  </span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="op">}</span></span>
<span id="cb2-24"><a href="#cb2-24"></a>SEXP getXPtr <span class="op">()</span>  <span class="op">{</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>  <span class="kw">typedef</span> sexp <span class="op">(*</span>fct_ptr<span class="op">)</span> <span class="op">(</span>sexp a<span class="op">);</span></span>
<span id="cb2-26"><a href="#cb2-26"></a>  <span class="cf">return</span> Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>fct_ptr<span class="op">&gt;(</span><span class="kw">new</span> fct_ptr<span class="op">(&amp;</span>bubbleSort<span class="op">));</span></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="op">}</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="internals-of-etr">Internals of ETR<a class="anchor" aria-label="anchor" href="#internals-of-etr"></a>
</h2>
<div class="section level3">
<h3 id="fundamental-type-in-expression-template-library-r-etr-vec-class">Fundamental Type in Expression Template Library R (ETR): Vec
Class<a class="anchor" aria-label="anchor" href="#fundamental-type-in-expression-template-library-r-etr-vec-class"></a>
</h3>
<p>The core type in the expression template library R (ETR) is a class
called <em>Vec</em>. Presuming a foundational familiarity with classes
and templates in C++, we embark on a detailed exploration of the design
inherent in this class. The Vec class incorporates three templates,
namely <em>T</em>, <em>R</em>, and <em>Trait</em>. In this context, the
typename <em>T</em> signifies a fundamental data type, while <em>R</em>
represents another class (more details forthcoming). The third template,
<em>Trait</em>, plays a crucial role in endowing the class with
identifiable properties as Vec during the compile-time phase. In the
majority of instances, the template <em>T</em> is instantiated as a
<em>double</em>, referred to as numeric in the context of R types. On
certain occasions, <em>T</em> is a <em>bool</em>, denoted as
<em>logical</em> in the realm of R types. The typename <em>R</em>
represents another class this can be either: Buffer, BorrowSEXP, Borrow,
Subset, UnaryOperation or BinaryOperation. Each of these classes
contributes distinct functionalities and features to the <em>Vec</em>
class. It is recommended to directly use only the classes Buffer,
BorrowSEXP and Borrow. The Subset class is yielded by calls to the
function subset. Whereas UnaryOperation or BinaryOperation are produced
by invoking functions like <em>sin</em>, <em>cos</em>, <em>+</em> and
<em>-</em>.<br>
Under the hood, regardless whether they represent dataframes, vectors,
functions or any other R type, all variables are of type <em>SEXP</em>
in R. As an allusion to this fact the basic type used for most variables
is called <em>sexp</em>. Where <em>sexp</em> is an alias for
<em>Vec<:basetype></:basetype></em> (where <em>etr::BaseType</em> itself is an
alias for <em>double</em>). The <em>sexp</em> class uses an instance of
class <em>Buffer<t></t></em> which manages the memory of the variable. To do
this a raw pointer of the form <em>T*</em> is used. Thus, all objects
are located at the heap.<br>
As mentioned in other sections of the documentation an R function can be
either translated to an R function which calls a C++ function or to an
external pointer to a C++ function. If an R function is desired as
output form the function expects that all arguments passed to it are of
type <em>SEXP</em> and furthermore that the function always returns an
element of <em>SEXP</em>. Due to this a class called
<em>WrapperSEXP</em> was introduced which is equivalent to
<em>Vec&lt;etr::BaseType, etr::BorrowSEXP&gt;</em>. Whenever, you want
to use a <em>SEXP</em> object in C++ it is necessary to construct an
object of type <em>WrapperSEXP</em> and assign the <em>SEXP</em> object
to it (see the code snippet below). Notably, the <em>WrapperSEXP</em>
class works with the original memory section as long as it is not
increased above the size of the <em>SEXP</em> object. Thus, R objects
can be changed as side effect, which differs from the normal R behaviour
but increases the performance. Moreover, each object that is returned is
converted into a <em>SEXP</em> object. This is done by the function
<em>cpp2R</em>. If no return statement is found the command
<em>return(R_NilValue);</em> is added to the code. Thereby, the function
returns <em>NULL</em>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>SEXP handleSEXP<span class="op">(</span>SEXP aSEXP<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>   WrapperSEXP a<span class="op">;</span> a <span class="op">=</span> aSEXP<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>   <span class="co">/* rest of code*/</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>   <span class="cf">return</span><span class="op">(</span>etr<span class="op">::</span>cpp2R<span class="op">(</span>a<span class="op">));</span>  </span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-xptr-interface">The XPtr interface<a class="anchor" aria-label="anchor" href="#the-xptr-interface"></a>
</h3>
<p>In contrast if the external pointer interface is used a broader range
of argument types can be used. However, <em>SEXP</em> cannot be used.
The user who translates the function can choose between: <em>sexp</em>,
<em>double</em>, <em>ptr_vec</em>, <em>ptr_mat</em> and
<em>BorrowPtr</em>. This arguments can be either passed by copy or by
reference. This is handled by the boolean <em>reference</em> argument in
R. For ptr_vec or ptr_mat, two (for vectors) and three (for matrices)
arguments are passed to the function. The first one is the pointer
pointing to the start of the memory area. In case of <em>vec</em> the
second argument is of type int defining the size of the memory section.
If it is a matrix two <em>int</em> arguments are used defining the
number of rows and columns respectivly. In case the values should be
copied the elements are passed to a <em>sexp</em> object which copies
the memory section to a new one which is than handled by the class. In
contrast if the elements are passed by reference an object of type
<em>BorrowPtr</em> is used. <em>BorrowPtr</em> is an alias for
<em>Vec&lt;etr::BaseType, etr::Borrow&gt;</em>. The class
<em>BorrowPtr</em> behaves in the same way as a <em>sexp</em> object
except that it cannot be resized. Thus, it behaves as a wrapper around
the raw pointer providing the convenience of the library. Moreover, the
memory section is not deleted at the end of the function. Therefore, the
user which passes the pointer and the size arguments has to handle the
memory itself. The advantage is that something can be written in the
memory section as side effect of the function which is very
efficient.</p>
<div class="section level4">
<h4 id="using-raw-pointers">Using raw pointers<a class="anchor" aria-label="anchor" href="#using-raw-pointers"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co">// [[Rcpp::depends(ast2ast)]]</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp2a)]]</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="pp">#include </span><span class="im">"etr.hpp"</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>sexp ptrVecCopy<span class="op">(</span>etr<span class="op">::</span>BaseType<span class="op">*</span> a_double_ptr <span class="op">,</span> <span class="dt">int</span> a_int_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>   sexp a<span class="op">(</span>a_double_ptr<span class="op">,</span>a_int_size<span class="op">);</span> </span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>   <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;</span>i<span class="op">:</span>  etr<span class="op">::</span>colon<span class="op">(</span>etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">1</span><span class="op">),</span> etr<span class="op">::</span>length<span class="op">(</span>a<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>         etr<span class="op">::</span>subset<span class="op">(</span>a<span class="op">,</span> i<span class="op">)</span> <span class="op">=</span> i <span class="op">*</span> etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">2</span><span class="op">);</span>    </span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>     <span class="op">}</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>   <span class="cf">return</span><span class="op">(</span>a<span class="op">);</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>sexp ptrVecReference<span class="op">(</span>etr<span class="op">::</span>BaseType<span class="op">*</span> a_double_ptr <span class="op">,</span> <span class="dt">int</span> a_int_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>   BorrowPtr a<span class="op">(</span>a_double_ptr<span class="op">,</span>a_int_size<span class="op">);</span> </span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>   <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;</span>i<span class="op">:</span>  etr<span class="op">::</span>colon<span class="op">(</span>etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">1</span><span class="op">),</span> etr<span class="op">::</span>length<span class="op">(</span>a<span class="op">)))</span> <span class="op">{</span> </span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>         etr<span class="op">::</span>subset<span class="op">(</span>a<span class="op">,</span> i<span class="op">)</span> <span class="op">=</span> i <span class="op">*</span> etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">2</span><span class="op">);</span>    </span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>     <span class="op">}</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>   <span class="cf">return</span><span class="op">(</span>a<span class="op">);</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="dt">void</span> callFct <span class="op">()</span>  <span class="op">{</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>  <span class="dt">int</span> size <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>  <span class="dt">double</span><span class="op">*</span> ptr <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[</span>size<span class="op">];</span></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span> ptr<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>  ptrVecCopy<span class="op">(</span>ptr<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span> Rcpp<span class="op">::</span>Rcout <span class="op">&lt;&lt;</span> ptr<span class="op">[</span>i<span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">;</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>  Rcpp<span class="op">::</span>Rcout <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>  ptrVecReference<span class="op">(</span>ptr<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span> Rcpp<span class="op">::</span>Rcout <span class="op">&lt;&lt;</span> ptr<span class="op">[</span>i<span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span><span class="op">;</span></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>  <span class="kw">delete</span><span class="op">[]</span> ptr<span class="op">;</span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">callFct</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 0    0   0   </span></span>
<span><span class="co">## 2    4   6   </span></span></code></pre>
</div>
<div class="section level4">
<h4 id="using-borrow">Using Borrow<a class="anchor" aria-label="anchor" href="#using-borrow"></a>
</h4>
<p>Instead of passing the raw pointer directly it is also possible to
pass it wrapped in a class BorrowPtr. As a side note it does not make a
difference whether the argument is passed by reference or not.
Furthermore, BorrowPtr cannot be returned from a function. Here is an
example for this:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co">// [[Rcpp::depends(ast2ast)]]</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp2a)]]</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="pp">#include </span><span class="im">"etr.hpp"</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="dt">void</span> otherFct<span class="op">(</span>BorrowPtr a<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  subset<span class="op">(</span>a<span class="op">,</span> <span class="kw">true</span><span class="op">)</span> <span class="op">=</span> <span class="fl">3.14</span><span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="dt">void</span> callFct <span class="op">()</span>  <span class="op">{</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>  <span class="dt">int</span> size <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>  <span class="dt">double</span><span class="op">*</span> ptr <span class="op">=</span> <span class="kw">new</span> <span class="dt">double</span><span class="op">[</span>size<span class="op">];</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> i<span class="op">++)</span> ptr<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>  BorrowPtr a<span class="op">(</span>ptr<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>  otherFct<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>  etr<span class="op">::</span>print<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>  <span class="kw">delete</span><span class="op">[]</span> ptr<span class="op">;</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">callFct</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 3.14 3.14 3.14</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="using-sexp-instead-of-pointers">Using sexp instead of pointers<a class="anchor" aria-label="anchor" href="#using-sexp-instead-of-pointers"></a>
</h4>
<p>Notably, the same thing can be achieved with a <em>sexp</em> object
without using raw pointers. Here the code to illustrate it:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp2a)]]</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo, ast2ast)]]</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">"etr.hpp"</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="dt">void</span> byRef<span class="op">(</span>sexp<span class="op">&amp;</span> a<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;</span>i<span class="op">:</span>  etr<span class="op">::</span>colon<span class="op">(</span>etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">1</span><span class="op">),</span> etr<span class="op">::</span>length<span class="op">(</span>a<span class="op">)))</span> <span class="op">{</span> </span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>       etr<span class="op">::</span>subset<span class="op">(</span>a<span class="op">,</span> i<span class="op">)</span> <span class="op">=</span> i <span class="op">*</span> etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">2</span><span class="op">);</span>  </span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="dt">void</span> call_fct<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  sexp a <span class="op">=</span> etr<span class="op">::</span>vector_numeric<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>  etr<span class="op">::</span>print<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>  byRef<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>  etr<span class="op">::</span>print<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">call_fct</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 0 0 0 </span></span>
<span><span class="co">## 2 4 6</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="thread-safety">Thread safety<a class="anchor" aria-label="anchor" href="#thread-safety"></a>
</h3>
<p>The class <em>Vec</em> is thread safe in the sense that no memory is
associated with functions or global variables. Moreover, almost no
static methods are defined. An exception are the methods used for
comparison. Notably, these comparison methods (<em>==</em>,
<em>&lt;=</em>, <em>&gt;=</em>, <em>&lt;</em>, <em>&gt;</em> and
<em>!=</em>) except two doubles (by copy) as arguments and return a
bool. Thus, it is still possible to use instances of the class in
parallel. However, the user has to take care that only one thread edits
an object at a time.</p>
</div>
<div class="section level3">
<h3 id="conversions">Conversions<a class="anchor" aria-label="anchor" href="#conversions"></a>
</h3>
<p>A <em>sexp</em> can be converted to Rcpp::NumericVectors,
Rcpp::NumericMatrices, arma::vec or to a arma::mat.</p>
</div>
<div class="section level3">
<h3 id="rcpp-interface">Rcpp Interface<a class="anchor" aria-label="anchor" href="#rcpp-interface"></a>
</h3>
<p>In the last section, the usage of <em>ast2ast</em> was described.
However, only <em>sexp</em> variables were defined. Which are most
likely not used in your package. Therefore interfaces to common
libraries are defined. First of all, <em>ast2ast</em> can communicate
with Rcpp which alleviates working with the library substantially. The
code below shows that it is possible to pass a <em>sexp</em> object to a
variable of type <em>NumericVector</em> or <em>NumericMatrix</em> and
<em>vice versa</em>. Here, the data is always copied.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co">// [[Rcpp::depends(ast2ast, RcppArmadillo)]]</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp2a)]]</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;etr.hpp&gt;</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> etr<span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="dt">void</span> fct<span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  <span class="co">// NumericVector to sexp</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>  NumericVector a<span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">};</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>  sexp <span class="va">a_</span> <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>  print<span class="op">(</span><span class="va">a_</span><span class="op">);</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>  </span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>  <span class="co">// sexp to NumericVector</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>  sexp <span class="va">b_</span> <span class="op">=</span> coca<span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">);</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>  NumericVector b <span class="op">=</span> <span class="va">b_</span><span class="op">;</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>  Rcpp<span class="op">::</span>Rcout <span class="op">&lt;&lt;</span> b <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>  </span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>  <span class="co">// NumericMatrix to sexp</span></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>  NumericMatrix c<span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>  sexp <span class="va">c_</span> <span class="op">=</span> c<span class="op">;</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>  print<span class="op">(</span><span class="va">c_</span><span class="op">);</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>  </span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>  <span class="co">// sexp to NumericMatrix</span></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a>  sexp <span class="va">d_</span> <span class="op">=</span> matrix<span class="op">(</span>colon<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">16</span><span class="op">),</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">4</span><span class="op">);</span></span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a>  NumericMatrix d <span class="op">=</span> <span class="va">d_</span><span class="op">;</span></span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a>  Rcpp<span class="op">::</span>Rcout <span class="op">&lt;&lt;</span> d <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trash</span> <span class="op">&lt;-</span> <span class="fu">fct</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 1 2 </span></span>
<span><span class="co">## 3 4</span></span>
<span><span class="co">## 0    0   0   </span></span>
<span><span class="co">## 0    0   0   </span></span>
<span><span class="co">## 0    0   0   </span></span>
<span><span class="co">## 1.00000 5.00000 9.00000 13.0000</span></span>
<span><span class="co">## 2.00000 6.00000 10.0000 14.0000</span></span>
<span><span class="co">## 3.00000 7.00000 11.0000 15.0000</span></span>
<span><span class="co">## 4.00000 8.00000 12.0000 16.0000</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="rcpparmadillo-interface">RcppArmadillo Interface<a class="anchor" aria-label="anchor" href="#rcpparmadillo-interface"></a>
</h3>
<p>Besides Rcpp types, <em>sexp</em> objects can transfer data to
<em>RcppArmadillo</em> objects and it is also possible to copy the data
from <em>RcppArmadillo</em> types to <em>sexp</em> objects using the
operator <em>=</em>. The code below shows that it is possible to pass a
<em>sexp</em> object to a variable of type <em>vec</em> or <em>mat</em>
and <em>vice versa</em>. Here the data is always copied.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co">// [[Rcpp::depends(ast2ast, RcppArmadillo)]]</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp2a)]]</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> arma<span class="op">;</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;etr.hpp&gt;</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> etr<span class="op">;</span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="dt">void</span> fct<span class="op">()</span> <span class="op">{</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>  <span class="co">// vec to sexp</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>  arma<span class="op">::</span>vec a<span class="op">(</span><span class="dv">4</span><span class="op">,</span> fill<span class="op">::</span>value<span class="op">(</span><span class="fl">30.0</span><span class="op">));</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>  sexp <span class="va">a_</span> <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>  print<span class="op">(</span><span class="va">a_</span><span class="op">);</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>  </span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>  <span class="co">// sexp to vec</span></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>  sexp <span class="va">b_</span> <span class="op">=</span> coca<span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">);</span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>  vec b <span class="op">=</span> <span class="va">b_</span><span class="op">;</span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>  b<span class="op">.</span>print<span class="op">();</span></span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>  </span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>  <span class="co">// mat to sexp</span></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>  mat c<span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> fill<span class="op">::</span>value<span class="op">(</span><span class="fl">31.0</span><span class="op">));</span></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>  sexp <span class="va">c_</span> <span class="op">=</span> c<span class="op">;</span></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>  print<span class="op">(</span><span class="va">c_</span><span class="op">);</span></span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>  </span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>  <span class="co">// sexp to mat</span></span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a>  sexp <span class="va">d_</span> <span class="op">=</span> matrix<span class="op">(</span>colon<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">16</span><span class="op">),</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">4</span><span class="op">);</span></span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a>  mat d <span class="op">=</span> <span class="va">d_</span><span class="op">;</span></span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a>  d<span class="op">.</span>print<span class="op">();</span></span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trash</span> <span class="op">&lt;-</span> <span class="fu">fct</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 30 30 30 30 </span></span>
<span><span class="co">##    3.0000</span></span>
<span><span class="co">##    4.0000</span></span>
<span><span class="co">## 31   31  31  </span></span>
<span><span class="co">## 31   31  31  </span></span>
<span><span class="co">## 31   31  31  </span></span>
<span><span class="co">##     1.0000    5.0000    9.0000   13.0000</span></span>
<span><span class="co">##     2.0000    6.0000   10.0000   14.0000</span></span>
<span><span class="co">##     3.0000    7.0000   11.0000   15.0000</span></span>
<span><span class="co">##     4.0000    8.0000   12.0000   16.0000</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="how-to-use-the-xptr-interface">How to use the XPtr interface<a class="anchor" aria-label="anchor" href="#how-to-use-the-xptr-interface"></a>
</h2>
<p>In this paragraph, a basic example demonstrates how to write the R
code, translate it to an external pointer and call it from C++.
Particular emphasis is placed on the C++ code. First of all, the R
function is defined which accepts one argument called <em>a</em>, adds
two to <em>a</em> and stores it into <em>b</em>. The variable <em>b</em>
is returned at the end of the function. The R function called <em>f</em>
is translated to an external pointer to the <em>C++</em> function.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">+</span> <span class="fl">2</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="op">}</span>  </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Konrad1991/ast2ast" class="external-link">ast2ast</a></span><span class="op">)</span></span>
<span><span class="va">f_cpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/translate.html">translate</a></span><span class="op">(</span><span class="va">f</span>, output <span class="op">=</span> <span class="st">"XPtr"</span>, return_type <span class="op">=</span> <span class="st">"etr::Vec&lt;double&gt;"</span><span class="op">)</span></span></code></pre></div>
<p>The C++ function depends on RcppArmadillo and ast2ast therefore the
required macros and headers were included. Moreover, <em>ETR</em>
requires std=c++20 therefore the corresponding plugin is added. The
function <em>getXPtr</em> is defined which is the function available in
R. Subsequently, the actual translated code is depicted. The function
<em>f</em> returns a <em>sexp</em> and gets one argument of type
<em>sexp</em> called <em>a</em>. The body of the function looks almost
identical to the R function. Except that the variable <em>b</em> is
defined in the first line of the body with the type <em>sexp</em>. The
function <em>i2d</em> converts an integer to a double variable. This is
necessary since C++ would identify the <em>2</em> as an integer which is
not what the user wants in this case.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co">// [[Rcpp::depends(ast2ast, RcppArmadillo)]]</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp2a)]]</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;etr.hpp&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>SEXP getXPtr<span class="op">();</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>sexp f<span class="op">(</span>sexp a<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>  sexp b<span class="op">;</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>  b <span class="op">=</span> a <span class="op">+</span> etr<span class="op">::</span>i2d<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>  <span class="cf">return</span><span class="op">(</span>b<span class="op">);</span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>SEXP getXPtr <span class="op">()</span>  <span class="op">{</span></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>  <span class="kw">typedef</span> sexp <span class="op">(*</span>fct_ptr<span class="op">)</span> <span class="op">(</span>sexp a<span class="op">);</span></span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>  <span class="cf">return</span> Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>fct_ptr<span class="op">&gt;(</span><span class="kw">new</span> fct_ptr<span class="op">(&amp;</span>f<span class="op">));</span></span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Afterwards, the translated R function has to be used in C++ code.
This would be your package code for example. First, the macros were
defined for <em>RcppArmadillo</em> and <em>ast2ast</em>. Subsequently,
the necessary header files were included. As already mentioned
<em>ast2ast</em> requires std=c++20 thus the required plugin is
included. To use the function, it is necessary to dereference the
pointer. The result of the dereferenced pointer has to be stored in a
function pointer. Later the function pointer can be used to call the
translated function. Therefore, a function pointer called <em>fp</em> is
defined. It is critical that the signature of the function pointer
matches the one of the translated function. Perhaps it would be a good
idea to check the R function or the produced C++ code before it is
translated. After defining the function pointer, a function is defined
which is called later by the user (called <em>call_package</em>). This
function accepts the external pointer. Within the function body, a
variable <em>f</em> is defined of type <em>fp</em> and <em>inp</em> is
assigned to it. Next, a <em>sexp</em> object called <em>a</em> is
defined which stores a vector of length 3 containing 1, 2 and 3. The
function <em>coca</em> is equivalent to the <em>c</em> function R.
Afterwards <em>a</em> is printed. Followed by the call of the function
<em>f</em> and storing the result in <em>a</em>. The variable <em>a</em>
is printed again to show that the values are changed according to the
code defined in the R function.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppArmadillo, ast2ast)]]</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="co">// [[Rcpp::plugins("cpp2a")]]</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">"etr.hpp"</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="kw">typedef</span> etr<span class="op">::</span>Vec<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="op">(*</span>FP<span class="op">)(</span>etr<span class="op">::</span>Vec<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> a<span class="op">);</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="dt">void</span> call_package<span class="op">(</span>Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>FP<span class="op">&gt;</span> inp<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>  FP f <span class="op">=</span> <span class="op">*</span>inp<span class="op">;</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>  sexp a <span class="op">=</span> etr<span class="op">::</span>coca<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>  etr<span class="op">::</span>print<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>  a <span class="op">=</span> f<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>  etr<span class="op">::</span>print<span class="op">(</span><span class="st">"a is now:"</span><span class="op">);</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>  etr<span class="op">::</span>print<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The user can call now the package code and pass the R function to it.
Thus, the user only has to install the compiler or Rtools depending on
the operating system. But it is not necessary to write the function in
Rcpp.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">call_package</span><span class="op">(</span><span class="va">f_cpp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 1 2 3 </span></span>
<span><span class="co">## a is now:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 3 4 5</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Krämer Konrad.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
